---
id: task-2
priority: blocker
status: pending
dependencies: []
labels:
  - parallel-execution
  - alignment-system
  - critical-path
---

# Task 2: Wire Drift Warnings to additionalContext

## Objective

Connect existing `calculate_drift()` and `generate_drift_warning()` to the additionalContext output so warnings actually appear in Claude's responses.

## Implementation Approach

1. **Locate the gap:**
   - Drift is calculated at line 707: `drift_score, drift_reason = calculate_drift(...)`
   - Warning text generated by generate_drift_warning() but never added to nudges

2. **Wire it up in `generate_workflow_nudges()`:**
```python
def generate_workflow_nudges(payload, session_id, feature, step):
    nudges = []
    
    # Existing nudges (commit reminder, etc.)
    ...
    
    # NEW: Drift warning
    drift_score = payload.get("driftScore", 0)
    if drift_score >= 0.7 and step:
        nudge_key = f"drift_warning_{step.get('id', 'unknown')}"
        if not db_helper.has_been_nudged(session_id, nudge_key):
            warning = generate_drift_warning(step, drift_score, payload.get("driftReason", ""))
            if warning:
                nudges.append(warning)
                db_helper.record_nudge(session_id, nudge_key)
    
    return nudges
```

3. **Ensure nudges reach additionalContext:**
   - Verify `hookSpecificOutput["additionalContext"]` is set

**Pattern to follow:**
- File: `track-event.py:406` - existing `generate_workflow_nudges()`
- Add drift warning alongside commit reminder pattern

## Files to Touch

**Modify:**
- `packages/claude-plugin/hooks/scripts/track-event.py`
  - Update `generate_workflow_nudges()` to include drift warnings
  - Pass drift data from payload to nudge generator

## Tests Required

**Integration:**
- [ ] Trigger high drift (work on unrelated files) â†’ warning appears
- [ ] Warning only shown once per step (nudge tracking)
- [ ] No warning when drift < 0.7

## Acceptance Criteria

- [ ] Drift warnings appear in additionalContext when score >= 0.7
- [ ] Warnings not repeated (per-step nudge tracking)
- [ ] Warning includes step description and drift reason
- [ ] No performance regression

## Notes

This is the critical missing piece. Drift is calculated but never surfaced. This task makes it visible to Claude.

---

**Worktree:** `worktrees/task-2`
**Branch:** `feature/task-2`
